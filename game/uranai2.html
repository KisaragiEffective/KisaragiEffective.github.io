<!DOCTYPE html>
<html>
<head>
<style>
  #share-tweet {
    background-color: #88f;
    color: #fff;
    padding: 0.2em;
  }
</style>  
<meta charset="utf-8"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
// <!--
window.addEventListener("load", (e) => {
  // https://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript
  const hashCode = s => s.split('').reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0);
  const userHash = () => {
    let index = 17;
    index += hashCode(window.navigator.userAgent);
    index *= 31;
    const d = new Date();
    // 日付のみが関係する
    index += d.getMonth();
    index *= 31;
    index += d.getDate();
    index *= 31;
    return index;
  };
  const assert = (o, b) => {
    if (!b()) throw Error(b.toString() + "Bad");
    return o;
  };
  const reportAjaxError = (xhr, textStatus, err) => {
    [xhr, textStatus, err].forEach(x => console.log(x));
  }
  // wikitionaryからstaticなクエリの結果を取得
  $.ajax({
    // 日替わりのランダムでソート
    // TODO: 動的に単語を得る
    url: 'https://quarry.wmflabs.org/run/483242/output/0/json',
    dataType: "json",
    cache: false,
    success: (data) => {
      console.log(data);
      // 負数を爆発四散！
      const index = Math.abs(userHash()) % data.rows.length;
      console.log(index);
      const lucky = {
        item: data.rows[index][0]
      };
      $('#message').html("今日のあなたのラッキーアイテムは「" + lucky.item + "」");
      $('#share-tweet')
        .attr('href', `https://twitter.com/intent/tweet?text=${encodeURIComponent("今日のラッキーアイテムは「" + lucky.item + "」\nhttps://kisaragieffective.github.io/game/uranai2.html")}`)
        .html("Share on twitter");
      // TODO: Lucky color
    },
    error: (xhr, textStatus, error) => {
      reportAjaxError(xhr, textStatus, error);
      $('#message').html("Fetch failed. Reload to retry.");
    }
  });
  // ^^^ wikitionary
  
  $.ajax({
    url: 'https://www.colordic.org/w',
    dataType: 'html',
    cache: 'true',
    success: (html) => {
      console.log(`success`);
      console.log(html);
    }
    error: (xhr, status, err) => reportAjaxError(xhr, status, err);
  });
});
// -->
</script>
</head>
<body>
<noscript>
JavaScriptを有効にしてください。
</noscript>
<p id="message">ロード中…</p>
<a id="share-tweet" class="twitter-share-button"></a>
</body>
</html>
